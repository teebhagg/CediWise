# Build Android APK via EAS (local) and publish to GitHub Releases.
# Uses EAS --local to avoid cloud build credits. Prunes old release assets (keeps last 3).
# Required secrets: EXPO_TOKEN, EXPO_PUBLIC_SUPABASE_URL, EXPO_PUBLIC_SUPABASE_KEY,
#   EXPO_PUBLIC_SUPABASE_ANON_KEY, FIREBASE_PROJECT_ID
# Trigger: push to main, push tag v*, or manual workflow_dispatch.
# Website uses releases/latest to get CediWise-{version}.apk for download.
name: Build Android APK & Release

permissions:
  contents: write

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g. 0.0.1). Uses app.json if empty."
        required: false

env:
  MOBILE_APP_DIR: cediwise-mobile-app

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from app.json
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            VERSION=$(jq -r '.expo.version' ${{ env.MOBILE_APP_DIR }}/app.json)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Determine should_build
        id: check
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            VERSION="${{ steps.version.outputs.version }}"
            LATEST_TAG=$(gh release view --json tagName -q .tagName 2>/dev/null || echo "v0.0.0")
            LATEST_VER="${LATEST_TAG#v}"
            if [ "$(printf '%s\n' "$LATEST_VER" "$VERSION" | sort -V | tail -1)" = "$VERSION" ] && [ "$LATEST_VER" != "$VERSION" ]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.MOBILE_APP_DIR }}/package-lock.json

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: ${{ env.MOBILE_APP_DIR }}
        run: npm ci

      - name: Inject secrets into eas.json
        working-directory: ${{ env.MOBILE_APP_DIR }}
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_KEY }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          node -e "
          const fs = require('fs');
          const eas = JSON.parse(fs.readFileSync('eas.json', 'utf8'));
          eas.build.production.env = {
            EXPO_PUBLIC_SUPABASE_URL: process.env.EXPO_PUBLIC_SUPABASE_URL,
            EXPO_PUBLIC_SUPABASE_KEY: process.env.EXPO_PUBLIC_SUPABASE_KEY,
            EXPO_PUBLIC_SUPABASE_ANON_KEY: process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY,
            FIREBASE_PROJECT_ID: process.env.FIREBASE_PROJECT_ID
          };
          fs.writeFileSync('eas.json', JSON.stringify(eas, null, 2));
          "

      - name: Build Android APK
        working-directory: ${{ env.MOBILE_APP_DIR }}
        run: npm run build:android
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_KEY }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: CediWise v${{ needs.check-version.outputs.version }}
          files: ${{ env.MOBILE_APP_DIR }}/dist/*.apk
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prune old release assets (keep last 3)
        continue-on-error: true
        run: |
          RELEASES=$(gh api "repos/${{ github.repository }}/releases" -q '[.[] | {id: .id, assets: [.assets[]? | .id]}]')
          echo "$RELEASES" | jq -c '.[3:][]' 2>/dev/null | while read -r release; do
            ASSET_IDS=$(echo "$release" | jq -r '.assets[]? // empty')
            for asset_id in $ASSET_IDS; do
              [ -n "$asset_id" ] && gh api -X DELETE "repos/${{ github.repository }}/releases/assets/$asset_id" && echo "Deleted asset $asset_id"
            done
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
